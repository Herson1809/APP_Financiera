{% extends "base.html" %}
{% block title %}Inicio – FinPlatform{% endblock %}

{% block content %}

{# ==== Filtros de periodo y navegación ==== #}
<div class="card mb-3">
  <div class="card-body d-flex flex-wrap gap-2 align-items-center">
    <form method="get" class="d-flex align-items-center gap-2">
      <label class="form-label m-0"><small>Período</small></label>
      <select class="form-select form-select-sm" name="period" style="width:auto; min-width: 140px;">
        {% for code in available_periods %}
          <option value="{{ code }}" {% if code == fin_period_label %}selected{% endif %}>{{ code }}</option>
        {% endfor %}
      </select>
      {# Si más adelante agregas filtros de company/scenario por querystring, inclúyelos aquí como inputs hidden #}
      <button class="btn btn-sm btn-primary" type="submit">Ver</button>
    </form>

    <div class="ms-auto d-flex align-items-center gap-2">
      {% if prev_period_code %}
        <a class="btn btn-sm btn-outline-secondary"
           href="?period={{ prev_period_code }}">⟵ {{ prev_period_code }}</a>
      {% endif %}
      {% if next_period_code %}
        <a class="btn btn-sm btn-outline-secondary"
           href="?period={{ next_period_code }}">{{ next_period_code }} ⟶</a>
      {% endif %}
    </div>
  </div>
</div>

{# ==== CARDS FINANCIERAS ==== #}
<div class="row g-3 mb-3">
  <div class="col-12 col-md-3">
    <div class="card kpi-card">
      <div class="card-body">
        <div class="small text-muted">Ingresos {{ fin_period_label|default:"—" }}</div>
        <div class="fs-4 fw-bold">
          {{ ingresos_total|default:0|floatformat:2 }} USD
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="card kpi-card">
      <div class="card-body">
        <div class="small text-muted">Gastos {{ fin_period_label|default:"—" }}</div>
        <div class="fs-4 fw-bold">
          {{ gastos_total|default:0|floatformat:2 }} USD
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="card kpi-card">
      <div class="card-body">
        <div class="small text-muted">Resultado operativo {{ fin_period_label|default:"—" }}</div>
        <div class="fs-4 fw-bold">
          {{ resultado_operativo|default:0|floatformat:2 }} USD
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-3">
    <div class="card kpi-card">
      <div class="card-body">
        <div class="small text-muted">Empresa / Escenario</div>
        <div class="fs-6 fw-semibold">
          {{ fin_company.name|default:"—" }} — {{ fin_scenario.name|default:"—" }}
        </div>
      </div>
    </div>
  </div>
</div>

{# ==== KPIs (bloque existente) ==== #}
<div class="row g-3 mb-3">
  {% for k in kpis %}
    <div class="col-6 col-md-3">
      <div class="card kpi-card">
        <div class="card-body">
          <div class="small text-muted">{{ k.name }}</div>
          <div class="fs-4 fw-bold">
            {{ k.value|floatformat:2 }} {{ k.unit }}
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="alert alert-light border">
        Sin KPIs aún. Importa datos para ver indicadores.
      </div>
    </div>
  {% endfor %}
</div>

{# ==== Desglose por cuenta del período seleccionado ==== #}
<div class="card mb-3">
  <div class="card-header fw-semibold">
    Desglose por cuenta – {{ fin_period_label }}
  </div>
  <div class="table-responsive">
    <table class="table mb-0">
      <thead>
        <tr>
          <th style="width: 140px;">Cuenta</th>
          <th>Nombre</th>
          <th style="width: 160px;">Tipo</th>
          <th style="width: 160px;" class="text-end">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for r in breakdown_accounts %}
          <tr>
            <td><code>{{ r.code }}</code></td>
            <td>{{ r.name }}</td>
            <td>{{ r.type }}</td>
            <td class="text-end">{{ r.total|floatformat:2 }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-muted">Sin datos para este período.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# ==== Tabla de escenarios recientes (bloque existente) ==== #}
<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between">
    <span class="fw-semibold">Escenarios recientes</span>
    <a class="btn btn-sm btn-outline-primary" href="/admin/">Admin</a>
  </div>
  <div class="table-responsive">
    <table class="table mb-0">
      <thead>
        <tr>
          <th>Empresa</th>
          <th>Escenario</th>
          <th>Creado</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for s in scenarios %}
          <tr>
            <td>{{ s.company.name }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.created_at }}</td>
            <td>
              {% if s.is_locked %}
                <span class="badge bg-secondary">Cerrado</span>
              {% else %}
                <span class="badge bg-success">Abierto</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-muted">
              Aún no hay escenarios. Importa CSV para crear el primero.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
